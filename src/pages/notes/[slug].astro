---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Skeleton from '../../components/ui/Skeleton.astro';
import { getNoteBySlug, getAllNotes, type Note } from '../../lib/notes';

export const prerender = false;

const { slug } = Astro.params;
const lang = 'en';

// Get the current note
const note: Note | null = await getNoteBySlug(slug || '', lang);

// If note doesn't exist, return 404
if (!note) {
  return Astro.redirect('/404');
}

// Get related notes (same category, excluding current)
const allNotes = await getAllNotes(lang);
const relatedNotes = allNotes.filter(n => n.category === note.category && n.slug !== slug).slice(0, 3);

const currentPath = Astro.url.pathname;
const currentLang = 'en';

const title = `${note.title} - Syaiful Anam`;
const description = note.summary || `Read about ${note.title} in my notebook.`;

// Format date helper
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};
---

<Layout title={title} description={description} lang={currentLang}>
	<div class="container">
		<Header currentPath={currentPath} lang={currentLang} />

		<main class="main-content">
			<!-- Skeleton loader for page transitions -->
			<div id="skeleton-container" class="skeleton-loading" aria-hidden="true">
				<div class="skeleton-wrapper">
					<div class="skeleton-image"></div>
					<div class="skeleton-meta"></div>
					<div class="skeleton-title"></div>
					<div class="skeleton-summary"></div>
					<div class="skeleton-content"></div>
					<div class="skeleton-content"></div>
					<div class="skeleton-content"></div>
				</div>
			</div>

			<article class="note-article">
				{note.headerImage && (
					<div class="note-header-image">
						<img src={note.headerImage} alt={note.title} />
					</div>
				)}
				<header class="note-header">
					<div class="note-meta">
						<time datetime={note.publishedDate} class="note-date">
							{formatDate(note.publishedDate)}
						</time>
						<span class="note-category">{note.category}</span>
					</div>

					<h1 class="note-title">{note.title}</h1>

					{note.summary && <p class="note-summary">{note.summary}</p>}

					{note.tags && note.tags.length > 0 && (
						<div class="note-tags">
							{note.tags.map((tagItem) => (
								<span class="tag">{tagItem}</span>
							))}
						</div>
					)}
				</header>

				<div class="note-content">
					<div set:html={note.content}></div>
				</div>

				<footer class="note-footer">
					<div class="note-navigation">
						<a href="/notes" class="back-link">← Back to all notes</a>
					</div>
				</footer>
			</article>

			{relatedNotes.length > 0 && (
				<section class="related-notes">
					<h2>Related Notes</h2>
					<div class="related-grid">
						{relatedNotes.map((relatedNote) => (
							<article class="related-card">
								<div class="related-meta">
									<time datetime={relatedNote.publishedDate}>
										{formatDate(relatedNote.publishedDate)}
									</time>
									<span class="related-category">{relatedNote.category}</span>
								</div>

								<h3>
									<a href={`/notes/${relatedNote.slug}`}>{relatedNote.title}</a>
								</h3>

								{relatedNote.summary && <p>{relatedNote.summary}</p>}

								<a href={`/notes/${relatedNote.slug}`} class="read-more">
									Read more →
								</a>
							</article>
						))}
					</div>
				</section>
			)}
		</main>
		<Footer lang={currentLang} />
	</div>

	<script>
		// Skeleton loading for view transitions
		const skeletonContainer = document.getElementById('skeleton-container');
		const noteArticle = document.querySelector('.note-article');

		function showSkeleton() {
			if (skeletonContainer) {
				skeletonContainer.classList.add('active');
			}
			if (noteArticle) {
				noteArticle.classList.add('loading');
			}
		}

		function hideSkeleton() {
			if (skeletonContainer) {
				skeletonContainer.classList.remove('active');
			}
			if (noteArticle) {
				noteArticle.classList.remove('loading');
			}
		}

		// Show skeleton on navigation start
		document.addEventListener('astro:before-preparation', showSkeleton);
		document.addEventListener('astro:after-preparation', hideSkeleton);

		// Also hide skeleton on page load complete
		document.addEventListener('astro:page-load', hideSkeleton);
		document.addEventListener('DOMContentLoaded', hideSkeleton);

		// Enhanced smooth scroll for table of contents
		document.addEventListener('astro:page-load', () => {
			initSmoothScroll();
		});

		// Also initialize on initial load
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initSmoothScroll);
		} else {
			initSmoothScroll();
		}

		function initSmoothScroll() {
			// Find all anchor links in the content
			const noteContent = document.querySelector('.note-content');
			if (!noteContent) return;

			const anchorLinks = noteContent.querySelectorAll('a[href^="#"]');

			anchorLinks.forEach(anchor => {
				anchor.addEventListener('click', function(e) {
					e.preventDefault();
					const targetId = this.getAttribute('href');
					const targetElement = document.querySelector(targetId);

					if (targetElement) {
						const headerHeight = 100; // Account for fixed header
						const targetPosition = targetElement.getBoundingClientRect().top + window.scrollY - headerHeight;

						window.scrollTo({
							top: targetPosition,
							behavior: 'smooth'
						});

						// Update URL without jumping
						history.pushState(null, null, targetId);
					}
				});
			});

			// Handle direct navigation with hash
			if (window.location.hash) {
				const targetElement = document.querySelector(window.location.hash);
				if (targetElement) {
					setTimeout(() => {
						const headerHeight = 100;
						const targetPosition = targetElement.getBoundingClientRect().top + window.scrollY - headerHeight;
						window.scrollTo({
							top: targetPosition,
							behavior: 'smooth'
						});
					}, 300);
				}
			}
		}
	</script>
</Layout>

<style>
	.main-content {
		min-height: calc(100vh - 200px);
	}

	/* Skeleton loading styles */
	.skeleton-loading {
		display: none;
	}

	.skeleton-loading.active {
		display: block;
	}

	.skeleton-wrapper {
		max-width: 800px;
		margin: 0 auto;
		padding: var(--spacing-xl) 0;
	}

	.skeleton-image {
		width: 100%;
		height: 300px;
		background: linear-gradient(90deg, var(--color-surface) 25%, var(--color-border) 50%, var(--color-surface) 75%);
		background-size: 200% 100%;
		animation: shimmer 1.5s infinite;
		border-radius: 12px;
		margin-bottom: var(--spacing-xl);
	}

	.skeleton-meta {
		display: flex;
		gap: var(--spacing-sm);
		margin-bottom: var(--spacing-md);
	}

	.skeleton-meta::before,
	.skeleton-meta::after {
		content: '';
		height: 20px;
		border-radius: 12px;
		background: linear-gradient(90deg, var(--color-surface) 25%, var(--color-border) 50%, var(--color-surface) 75%);
		background-size: 200% 100%;
		animation: shimmer 1.5s infinite;
	}

	.skeleton-meta::before {
		width: 120px;
	}

	.skeleton-meta::after {
		width: 80px;
	}

	.skeleton-title {
		height: 48px;
		background: linear-gradient(90deg, var(--color-surface) 25%, var(--color-border) 50%, var(--color-surface) 75%);
		background-size: 200% 100%;
		animation: shimmer 1.5s infinite;
		border-radius: 8px;
		margin-bottom: var(--spacing-md);
	}

	.skeleton-summary {
		height: 28px;
		background: linear-gradient(90deg, var(--color-surface) 25%, var(--color-border) 50%, var(--color-surface) 75%);
		background-size: 200% 100%;
		animation: shimmer 1.5s infinite;
		border-radius: 8px;
		margin-bottom: var(--spacing-md);
		width: 90%;
	}

	.skeleton-content {
		height: 20px;
		background: linear-gradient(90deg, var(--color-surface) 25%, var(--color-border) 50%, var(--color-surface) 75%);
		background-size: 200% 100%;
		animation: shimmer 1.5s infinite;
		border-radius: 8px;
		margin-bottom: var(--spacing-sm);
	}

	.skeleton-content:nth-child(6) {
		width: 95%;
	}

	.skeleton-content:nth-child(7) {
		width: 85%;
	}

	@keyframes shimmer {
		0% {
			background-position: -200% 0;
		}
		100% {
			background-position: 200% 0;
		}
	}

	/* Hide real content during skeleton loading */
	.note-article.loading {
		opacity: 0;
		pointer-events: none;
	}

	.note-article {
		max-width: 800px;
		margin: 0 auto;
		padding: var(--spacing-xl) 0;
	}

	.note-header-image {
		width: 100%;
		height: auto;
		border-radius: 12px !important;
		overflow: hidden !important;
		margin-bottom: var(--spacing-xl);
		display: block;
	}

	.note-header-image img {
		width: 100%;
		height: auto;
		object-fit: contain;
	}

	.note-header {
		margin-bottom: var(--spacing-xl);
	}

	.note-meta {
		display: flex;
		align-items: center;
		gap: var(--spacing-sm);
		margin-bottom: var(--spacing-md);
		font-size: 0.875rem;
	}

	.note-date {
		color: var(--color-text-light);
	}

	.note-category {
		background-color: var(--color-accent);
		color: white;
		padding: 2px var(--spacing-sm);
		border-radius: 12px;
		font-weight: 600;
		font-size: 0.75rem;
	}

	.note-title {
		font-size: 2.5rem;
		line-height: 1.2;
		margin-bottom: var(--spacing-md);
		font-weight: 700;
	}

	.note-summary {
		font-size: 1.25rem;
		color: var(--color-text-secondary);
		line-height: 1.6;
		margin-bottom: var(--spacing-md);
		max-width: 800px;
		word-wrap: break-word;
		overflow-wrap: break-word;
	}

	.note-tags {
		display: flex;
		flex-wrap: wrap;
		gap: var(--spacing-xs);
	}

	.tag {
		background-color: var(--color-border);
		color: var(--color-text-secondary);
		padding: 4px var(--spacing-sm);
		border-radius: 12px;
		font-size: 0.875rem;
		font-weight: 500;
	}

	.note-content {
		margin-bottom: var(--spacing-2xl);
		line-height: 1.7;
		max-width: 1200px;
		word-wrap: break-word;
		overflow-wrap: break-word;
		overflow-x: hidden; /* Prevent horizontal overflow */
		margin: 0 auto; /* Center the content container */
	}

	/* Markdown content styles */
	.note-content :global(h1),
	.note-content :global(h2),
	.note-content :global(h3),
	.note-content :global(h4),
	.note-content :global(h5),
	.note-content :global(h6) {
		margin-top: var(--spacing-xl);
		margin-bottom: var(--spacing-md);
		font-weight: 600;
	}

	.note-content :global(h1) {
		font-size: 2rem;
	}

	.note-content :global(h2) {
		font-size: 1.75rem;
	}

	.note-content :global(h3) {
		font-size: 1.5rem;
	}

	.note-content :global(p) {
		margin-bottom: var(--spacing-md);
	}

	.note-content :global(ul),
	.note-content :global(ol) {
		margin-bottom: var(--spacing-md);
		padding-left: var(--spacing-lg);
	}

	.note-content :global(li) {
		margin-bottom: var(--spacing-xs);
	}

	.note-content :global(blockquote) {
		border-left: 4px solid var(--color-accent);
		padding-left: var(--spacing-lg);
		margin: var(--spacing-lg) 0;
		color: var(--color-text-secondary);
		font-style: italic;
	}

	.note-content :global(code) {
		background-color: var(--color-surface);
		padding: 2px 4px;
		border-radius: 4px;
		font-family: monospace;
		font-size: 0.875em;
	}

	.note-content :global(pre) {
		background-color: var(--color-surface);
		padding: var(--spacing-lg);
		border-radius: 8px;
		overflow-x: auto;
		margin-bottom: var(--spacing-md);
	}

	.note-content :global(pre code) {
		background: none;
		padding: 0;
	}

	.note-content :global(a) {
		color: var(--color-accent);
		text-decoration: none;
		border-bottom: 1px solid transparent;
		transition: border-color 0.2s ease;
	}

	.note-content :global(a:hover) {
		border-bottom-color: var(--color-accent);
	}

	.note-content :global(img) {
		max-width: 100%;
		height: auto;
		border-radius: 12px;
		display: block;
		margin: var(--spacing-lg) auto;
	}

	.note-footer {
		border-top: 1px solid var(--color-border);
		padding-top: var(--spacing-lg);
	}

	.back-link {
		color: var(--color-text-secondary);
		text-decoration: none;
		font-weight: 500;
		transition: color 0.2s ease;
	}

	.back-link:hover {
		color: var(--color-accent);
	}

	.related-notes {
		max-width: 800px;
		margin: var(--spacing-2xl) auto 0;
		padding: var(--spacing-xl) 0 var(--spacing-xl);
		border-top: 1px solid var(--color-border);
	}

	.related-notes h2 {
		font-size: 1.5rem;
		margin-top: 0;
		margin-bottom: var(--spacing-lg);
	}

	.related-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: var(--spacing-lg);
	}

	.related-card {
		background-color: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 12px;
		padding: var(--spacing-md) var(--spacing-lg) var(--spacing-lg);
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}

	.related-card:hover {
		transform: translateY(-2px);
		box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
	}

	.related-meta {
		display: flex;
		align-items: center;
		gap: var(--spacing-sm);
		margin-bottom: var(--spacing-xs);
		font-size: 0.75rem;
	}

	.related-meta time {
		color: var(--color-text-light);
	}

	.related-category {
		background-color: var(--color-border);
		color: var(--color-text-secondary);
		padding: 2px var(--spacing-xs);
		border-radius: 8px;
		font-weight: 600;
	}

	.related-card h3 {
		font-size: 1.125rem;
		margin-bottom: var(--spacing-sm);
	}

	.related-card h3 a {
		color: var(--color-text);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.related-card h3 a:hover {
		color: var(--color-accent);
	}

	.related-card p {
		color: var(--color-text-secondary);
		font-size: 0.875rem;
		margin-bottom: var(--spacing-md);
	}

	.read-more {
		color: var(--color-accent);
		font-weight: 600;
		text-decoration: none;
		font-size: 0.875rem;
		transition: color 0.2s ease;
	}

	.read-more:hover {
		color: var(--color-accent-hover);
	}

	/* Responsive design */
	@media (max-width: 768px) {
		.note-article {
			padding: var(--spacing-lg) 0;
		}

		.note-title {
			font-size: 2rem;
		}

		.note-summary {
			font-size: 1.125rem;
		}

		.note-meta {
			flex-direction: column;
			align-items: flex-start;
			gap: var(--spacing-xs);
		}

		.related-grid {
			grid-template-columns: 1fr;
		}
	}
</style>