---
import Layout from '../layouts/Layout.astro';
import { getNotesCollection, type Note } from '../lib/db';
import { ObjectId } from 'mongodb';
import marked from 'marked';

// Check if user is authenticated (disabled for testing)
// const isAuthenticated = Astro.request.headers.get('cookie')?.includes('admin-auth=true');

// if (!isAuthenticated) {
//   return new Response('Unauthorized', { status: 401 });
// }

// Get notes for listing
const collection = await getNotesCollection();
const notes = await collection
  .find({})
  .sort({ updatedAt: -1 })
  .toArray();

// Format date helper
const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};
---

<Layout title="Admin - Syanampro Notes" description="Admin dashboard for managing notes">
	<div class="admin-container">
		<header class="admin-header">
			<h1>Admin Dashboard</h1>
			<a href="/notes" class="view-site">View Site ‚Üí</a>
		</header>

		<main class="admin-main">
			<section class="create-note">
				<h2>Create New Note</h2>
				<form id="note-form" class="note-form">
					<!-- Language Tabs -->
					<div class="language-tabs">
						<button type="button" class="lang-tab active" data-lang="en">üá∫üá∏ English</button>
						<button type="button" class="lang-tab" data-lang="id">üáÆüá© Bahasa Indonesia</button>
					</div>

					<!-- English Content -->
					<div class="lang-content active" id="content-en">
						<div class="form-group">
							<label for="title_en">English Title *</label>
							<input type="text" id="title_en" name="title_en" required>
						</div>
						<div class="form-group">
							<label for="summary_en">English Summary</label>
							<textarea id="summary_en" name="summary_en" rows="3" placeholder="Brief description for the notes list..."></textarea>
						</div>
						<div class="form-group">
							<label for="content_en">English Content (Markdown) *</label>
							<textarea id="content_en" name="content_en" rows="15" placeholder="Write your content here..." required></textarea>
							<div class="content-image-upload">
								<button type="button" id="insertImageBtn_en" class="btn-secondary btn-small">Insert Image</button>
								<input type="file" id="contentImageInput_en" accept="image/*" style="display: none;" multiple />
							</div>
						</div>
					</div>

					<!-- Indonesian Content -->
					<div class="lang-content" id="content-id">
						<div class="form-group">
							<label for="title_id">Indonesian Title *</label>
							<input type="text" id="title_id" name="title_id" required>
						</div>
						<div class="form-group">
							<label for="summary_id">Indonesian Summary</label>
							<textarea id="summary_id" name="summary_id" rows="3" placeholder="Deskripsi singkat untuk daftar catatan..."></textarea>
						</div>
						<div class="form-group">
							<label for="content_id">Indonesian Content (Markdown) *</label>
							<textarea id="content_id" name="content_id" rows="15" placeholder="Tulis konten Anda di sini..." required></textarea>
							<div class="content-image-upload">
								<button type="button" id="insertImageBtn_id" class="btn-secondary btn-small">Insert Image</button>
								<input type="file" id="contentImageInput_id" accept="image/*" style="display: none;" multiple />
							</div>
						</div>
					</div>

					<!-- Shared Fields -->
					<div class="shared-fields">
						<h3>üìã Shared Settings</h3>
						<div class="form-row">
							<div class="form-group">
								<label for="category">Category *</label>
								<select id="category" name="category" required>
									<option value="">Select Category</option>
									<option value="Portfolio">Portfolio</option>
									<option value="Education">Education</option>
									<option value="Personal">Personal</option>
								</select>
							</div>
						</div>

						<div class="form-row">
							<div class="form-group">
								<label for="status">Status</label>
								<select id="status" name="status">
									<option value="draft">Draft</option>
									<option value="published">Published</option>
								</select>
							</div>
							<div class="form-group">
								<label for="publishedDate">Published Date</label>
								<input type="date" id="publishedDate" name="publishedDate">
							</div>
						</div>

						<div class="form-group">
							<label for="tags">Tags (comma separated)</label>
							<input type="text" id="tags" name="tags" placeholder="e.g., React, JavaScript, Web Development">
						</div>

						<div class="form-group">
							<label for="headerImage">Header Image</label>
							<input type="file" id="headerImage" accept="image/*" />
							<input type="hidden" id="headerImageUrl" name="headerImage" />
							<div id="headerImagePreview" class="image-preview" style="display: none;">
								<img id="headerImagePreviewImg" src="" alt="Header image preview" />
								<button type="button" id="removeHeaderImage" class="remove-image-btn">&times;</button>
							</div>
							<div class="image-upload-info">
								<small>Upload an image for the note header (optional)</small>
							</div>
						</div>
					</div>

	
					<div class="form-actions">
						<button type="submit" class="btn-primary">Save Note</button>
						<button type="button" id="preview-btn" class="btn-secondary">Preview</button>
					</div>
				</form>
			</section>

			<section class="notes-list">
				<div class="notes-header">
					<h2>Manage Notes</h2>
					<div class="notes-stats">
						<span class="stat">{notes.filter(n => n.status === 'published').length} Published</span>
						<span class="stat">{notes.filter(n => n.status === 'draft').length} Draft</span>
						<span class="stat">Total: {notes.length}</span>
					</div>
				</div>

				<div class="table-wrapper">
					<table class="notes-table">
						<thead>
							<tr>
								<th>Title</th>
								<th>Category</th>
								<th>Status</th>
								<th>Updated</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{notes.map((note) => {
								const id = note._id?.toString() || '';
								return (
									<tr class="note-row" data-id={id}>
										<td class="title-cell">
											<div>
												<strong>{note.title_en}</strong>
												{note.title_id && note.title_id !== note.title_en && (
													<div class="title-id">{note.title_id}</div>
												)}
											</div>
										</td>
										<td>
											<span class="category-tag">{note.category}</span>
										</td>
										<td>
											<span class={`status-badge ${note.status}`}>
												{note.status}
											</span>
										</td>
										<td>
											<time class="date-time">
												{new Date(note.updatedAt).toLocaleDateString()} ‚Ä¢ {new Date(note.updatedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
											</time>
										</td>
										<td>
											<div class="action-buttons">
												<button class="btn-action btn-view" onclick={`window.open('/notes/${note.slug}', '_blank')`} title="View">
													üëÅÔ∏è
												</button>
												<button class="btn-action btn-edit" onclick={`editNote('${id}')`} title="Edit">
													‚úèÔ∏è
												</button>
												<button class="btn-action btn-delete" onclick={`deleteNote('${id}')`} title="Delete">
													üóëÔ∏è
												</button>
											</div>
										</td>
									</tr>
								);
							})}
						</tbody>
					</table>
				</div>
			</section>
		</main>
	</div>

	<!-- Preview Modal -->
	<div id="preview-modal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2>Preview</h2>
				<button class="close-modal">&times;</button>
			</div>
			<div class="modal-body">
				<div id="preview-content"></div>
			</div>
		</div>
	</div>
</Layout>

<style>
	.admin-container {
		max-width: 1200px;
		margin: 0 auto;
		padding: var(--spacing-xl);
	}

	.admin-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: var(--spacing-xl);
		padding-bottom: var(--spacing-md);
		border-bottom: 1px solid var(--color-border);
	}

	.admin-header h1 {
		font-size: 2rem;
		margin: 0;
	}

	.view-site {
		color: var(--color-accent);
		text-decoration: none;
		font-weight: 600;
		transition: color 0.2s ease;
	}

	.view-site:hover {
		color: var(--color-accent-hover);
	}

	.admin-main {
		display: flex;
		flex-direction: column;
		gap: var(--spacing-2xl);
		max-width: 1200px;
		margin: 0 auto;
	}

	/* Form Styles */
	.note-form {
		background-color: var(--color-surface);
		padding: var(--spacing-lg);
		border-radius: 12px;
		border: 1px solid var(--color-border);
	}

	/* Language Tabs */
	.language-tabs {
		display: flex;
		gap: var(--spacing-xs);
		margin-bottom: var(--spacing-lg);
		border-bottom: 1px solid var(--color-border);
		padding-bottom: var(--spacing-xs);
	}

	.lang-tab {
		background: none;
		border: none;
		padding: var(--spacing-sm) var(--spacing-md);
		cursor: pointer;
		font-family: var(--font-sans);
		font-size: 1rem;
		font-weight: 500;
		color: var(--color-text-secondary);
		border-bottom: 2px solid transparent;
		transition: all 0.2s ease;
		display: flex;
		align-items: center;
		gap: var(--spacing-xs);
	}

	.lang-tab:hover {
		color: var(--color-text);
		background-color: var(--color-surface);
		border-radius: 6px 6px 0 0;
	}

	.lang-tab.active {
		color: var(--color-accent);
		border-bottom-color: var(--color-accent);
		background-color: var(--color-surface);
	}

	.lang-content {
		display: none;
	}

	.lang-content.active {
		display: block;
	}

	.shared-fields {
		border-top: 2px solid var(--color-border);
		padding-top: var(--spacing-lg);
		margin-top: var(--spacing-lg);
	}

	.shared-fields h3 {
		margin: 0 0 var(--spacing-md) 0;
		color: var(--color-text);
		font-size: 1.1rem;
		display: flex;
		align-items: center;
		gap: var(--spacing-xs);
	}

	.form-row {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: var(--spacing-md);
	}

	.form-group {
		margin-bottom: var(--spacing-md);
	}

	.form-group label {
		display: block;
		margin-bottom: var(--spacing-xs);
		font-weight: 600;
		color: var(--color-text);
	}

	.form-group input,
	.form-group select,
	.form-group textarea {
		width: 100%;
		padding: var(--spacing-sm);
		border: 1px solid var(--color-border);
		border-radius: 6px;
		background-color: var(--color-background);
		color: var(--color-text);
		font-family: var(--font-sans);
		font-size: 1rem;
		transition: border-color 0.2s ease;
	}

	/* Ensure all admin elements use SF Pro font */
	.admin-container,
	.admin-header *,
	.note-form *,
	.form-group label,
	.btn-primary,
	.btn-secondary,
	.btn-edit,
	.btn-delete,
	.modal *,
	.filter-btn {
		font-family: var(--font-sans);
	}

	.form-group input:focus,
	.form-group select:focus,
	.form-group textarea:focus {
		outline: none;
		border-color: var(--color-accent);
	}

	.form-group textarea {
		resize: vertical;
	}

	.form-actions {
		display: flex;
		gap: var(--spacing-sm);
		margin-top: var(--spacing-lg);
	}

	.btn-primary {
		background-color: var(--color-accent);
		color: white;
		border: none;
		padding: var(--spacing-sm) var(--spacing-lg);
		border-radius: 6px;
		font-weight: 600;
		cursor: pointer;
		transition: background-color 0.2s ease;
		font-family: var(--font-sans);
		font-size: 1rem;
		height: 44px;
		line-height: 1;
		display: inline-flex;
		align-items: center;
		justify-content: center;
	}

	.btn-primary:hover {
		background-color: var(--color-accent-hover);
	}

	.btn-secondary {
		background-color: var(--color-surface);
		color: var(--color-text);
		border: 1px solid var(--color-border);
		padding: var(--spacing-sm) var(--spacing-lg);
		border-radius: 6px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s ease;
		font-family: var(--font-sans);
		font-size: 1rem;
		height: 44px;
		line-height: 1;
		display: inline-flex;
		align-items: center;
		justify-content: center;
	}

	.btn-secondary:hover {
		background-color: var(--color-border);
	}

	/* Notes List - Table Layout */
	.notes-list {
		background-color: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 12px;
		padding: var(--spacing-lg);
	}

	.notes-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: var(--spacing-lg);
		padding-bottom: var(--spacing-md);
		border-bottom: 1px solid var(--color-border);
	}

	.notes-header h2 {
		margin: 0;
		font-size: 1.5rem;
		font-weight: 600;
	}

	.notes-stats {
		display: flex;
		gap: var(--spacing-md);
	}

	.stat {
		background-color: var(--color-background);
		padding: var(--spacing-xs) var(--spacing-sm);
		border-radius: 6px;
		font-size: 0.875rem;
		font-weight: 500;
		color: var(--color-text-secondary);
	}

	.table-wrapper {
		overflow-x: auto;
		border-radius: 8px;
		border: 1px solid var(--color-border);
		background-color: var(--color-background);
	}

	.notes-table {
		width: 100%;
		border-collapse: collapse;
		font-size: 0.875rem;
	}

	.notes-table thead {
		background-color: var(--color-surface);
		border-bottom: 2px solid var(--color-border);
	}

	.notes-table th {
		padding: var(--spacing-md);
		text-align: left;
		font-weight: 600;
		color: var(--color-text);
		font-size: 0.8125rem;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.notes-table tbody tr {
		border-bottom: 1px solid var(--color-border);
		transition: background-color 0.2s ease;
	}

	.notes-table tbody tr:hover {
		background-color: var(--color-surface);
	}

	.notes-table tbody tr:last-child {
		border-bottom: none;
	}

	.notes-table td {
		padding: var(--spacing-md);
		vertical-align: middle;
	}

	.title-cell {
		min-width: 250px;
		max-width: 400px;
	}

	.title-cell strong {
		display: block;
		font-weight: 600;
		color: var(--color-text);
		line-height: 1.4;
		margin-bottom: 2px;
	}

	.title-cell .title-id {
		font-size: 0.75rem;
		color: var(--color-text-secondary);
		font-style: italic;
		line-height: 1.3;
	}

	.category-tag {
		background-color: var(--color-accent);
		color: white;
		padding: 4px var(--spacing-sm);
		border-radius: 6px;
		font-size: 0.75rem;
		font-weight: 500;
		text-transform: capitalize;
	}

	.status-badge {
		padding: 4px var(--spacing-sm);
		border-radius: 6px;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: capitalize;
	}

	.status-badge.published {
		background-color: #22c55e;
		color: white;
	}

	.status-badge.draft {
		background-color: #f59e0b;
		color: white;
	}

	.date-time {
		font-size: 0.8125rem;
		color: var(--color-text-secondary);
		white-space: nowrap;
	}

	.action-buttons {
		display: flex;
		gap: var(--spacing-xs);
		justify-content: flex-end;
	}

	.btn-action {
		width: 32px;
		height: 32px;
		border: none;
		border-radius: 6px;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 0.875rem;
		transition: all 0.2s ease;
		background-color: var(--color-surface);
		border: 1px solid var(--color-border);
	}

	.btn-action:hover {
		transform: translateY(-1px);
	}

	.btn-action.btn-view:hover {
		background-color: #3b82f6;
		border-color: #3b82f6;
		color: white;
	}

	.btn-action.btn-edit:hover {
		background-color: #8b5cf6;
		border-color: #8b5cf6;
		color: white;
	}

	.btn-action.btn-delete:hover {
		background-color: #ef4444;
		border-color: #ef4444;
		color: white;
	}

	.note-meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		font-size: 0.875rem;
		color: var(--color-text-secondary);
		margin-bottom: var(--spacing-sm);
	}

	.category {
		background-color: var(--color-accent);
		color: white;
		padding: 2px 6px;
		border-radius: 4px;
		font-size: 0.75rem;
	}

	.note-actions {
		display: flex;
		gap: var(--spacing-xs);
	}

	.btn-edit,
	.btn-delete {
		padding: 4px 8px;
		border: none;
		border-radius: 4px;
		font-size: 0.75rem;
		cursor: pointer;
		transition: all 0.2s ease;
		font-family: var(--font-sans);
		line-height: 1;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		min-height: 28px;
	}

	.btn-edit {
		background-color: #3b82f6;
		color: white;
	}

	.btn-edit:hover {
		background-color: #2563eb;
	}

	.btn-delete {
		background-color: #ef4444;
		color: white;
	}

	.btn-delete:hover {
		background-color: #dc2626;
	}

	/* Modal */
	.modal {
		display: none;
		position: fixed;
		z-index: 1000;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.5);
	}

	.modal-content {
		background-color: var(--color-background);
		margin: 5% auto;
		padding: 0;
		border-radius: 12px;
		width: 90%;
		max-width: 800px;
		max-height: 80vh;
		overflow: hidden;
	}

	.modal-header {
		padding: var(--spacing-lg);
		border-bottom: 1px solid var(--color-border);
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.modal-header h2 {
		margin: 0;
	}

	.close-modal {
		background: none;
		border: none;
		font-size: 1.5rem;
		cursor: pointer;
		color: var(--color-text-secondary);
		font-family: var(--font-sans);
	}

	.modal-body {
		padding: var(--spacing-lg);
		overflow-y: auto;
		max-height: 60vh;
	}

	/* Image Upload Styles */
	.image-preview {
		position: relative;
		margin-top: var(--spacing-sm);
		border: 1px solid var(--color-border);
		border-radius: 6px;
		overflow: hidden;
		width: 200px;
		height: 120px;
	}

	.image-preview img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.remove-image-btn {
		position: absolute;
		top: 5px;
		right: 5px;
		background: rgba(0, 0, 0, 0.7);
		color: white;
		border: none;
		border-radius: 50%;
		width: 24px;
		height: 24px;
		cursor: pointer;
		font-size: 16px;
		line-height: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: background-color 0.2s ease;
	}

	.remove-image-btn:hover {
		background: rgba(0, 0, 0, 0.9);
	}

	.image-upload-info {
		margin-top: var(--spacing-xs);
		color: var(--color-text-secondary);
	}

	.content-image-upload {
		margin-top: var(--spacing-sm);
	}

	.btn-small {
		padding: var(--spacing-xs) var(--spacing-md);
		font-size: 0.875rem;
		height: auto;
		min-height: auto;
		line-height: 1.5;
	}

	/* Markdown Guide Styles */
	.markdown-guide {
		background-color: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 8px;
		padding: var(--spacing-md);
		margin-bottom: var(--spacing-sm);
	}

	.markdown-guide h4 {
		margin: 0 0 var(--spacing-sm) 0;
		font-size: 1rem;
		color: var(--color-text);
	}

	.guide-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: var(--spacing-sm);
		margin-bottom: var(--spacing-md);
	}

	.guide-item {
		display: flex;
		align-items: center;
		gap: var(--spacing-sm);
		padding: var(--spacing-xs);
		border-radius: 4px;
		background-color: var(--color-background);
	}

	.guide-item code {
		background-color: var(--color-border);
		padding: 2px 6px;
		border-radius: 4px;
		font-size: 0.75rem;
		font-family: monospace;
		flex-shrink: 0;
	}

	.guide-desc {
		font-size: 0.75rem;
		color: var(--color-text-secondary);
	}

	.guide-examples {
		border-top: 1px solid var(--color-border);
		padding-top: var(--spacing-sm);
		margin-top: var(--spacing-sm);
	}

	.guide-examples p {
		margin: 0 0 var(--spacing-xs) 0;
		font-size: 0.875rem;
	}

	.guide-examples ul {
		margin: 0;
		padding-left: var(--spacing-lg);
	}

	.guide-examples li {
		font-size: 0.75rem;
		color: var(--color-text-secondary);
		margin-bottom: var(--spacing-xs);
	}

	.guide-examples code {
		background-color: var(--color-border);
		padding: 1px 3px;
		border-radius: 2px;
		font-size: 0.75rem;
	}

	/* Responsive */
	@media (max-width: 768px) {
		.admin-main {
			gap: var(--spacing-xl);
		}

		.form-row {
			grid-template-columns: 1fr;
		}

		.admin-container {
			padding: var(--spacing-md);
		}

		.notes-table {
			font-size: 0.75rem;
		}

		.notes-table th,
		.notes-table td {
			padding: var(--spacing-sm);
		}

		.title-cell {
			min-width: 200px;
		}

		.action-buttons {
			flex-direction: column;
			gap: var(--spacing-xs);
		}

		.btn-action {
			width: 28px;
			height: 28px;
			font-size: 0.75rem;
		}
	}
</style>

<script>
	// Import marked for markdown parsing
	import { marked } from 'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js';

	// Set today's date as default
	document.getElementById('publishedDate').valueAsDate = new Date();

	// Language tabs functionality
	const langTabs = document.querySelectorAll('.lang-tab');
	const langContents = document.querySelectorAll('.lang-content');

	langTabs.forEach(tab => {
		tab.addEventListener('click', () => {
			const targetLang = tab.dataset.lang;

			// Update active tab
			langTabs.forEach(t => t.classList.remove('active'));
			tab.classList.add('active');

			// Update active content
			langContents.forEach(content => {
				content.classList.remove('active');
				if (content.id === `content-${targetLang}`) {
					content.classList.add('active');
				}
			});
		});
	});

	// Form submission
	document.getElementById('note-form').addEventListener('submit', async (e) => {
		e.preventDefault();

		const formData = new FormData(e.target);
		const data = {
			title_en: formData.get('title_en'),
			title_id: formData.get('title_id'),
			category: formData.get('category'),
			status: formData.get('status'),
			publishedDate: formData.get('publishedDate'),
			summary_en: formData.get('summary_en'),
			summary_id: formData.get('summary_id'),
			content_en: formData.get('content_en'),
			content_id: formData.get('content_id'),
			tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()) : [],
			headerImage: formData.get('headerImage') || null
		};

		try {
			const response = await fetch('/api/notes', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(data),
			});

			if (response.ok) {
				alert('Note created successfully!');
				e.target.reset();
				document.getElementById('publishedDate').valueAsDate = new Date();
				location.reload();
			} else {
				alert('Failed to create note');
			}
		} catch (error) {
			console.error('Error:', error);
			alert('Error creating note');
		}
	});

	// Preview functionality
	document.getElementById('preview-btn').addEventListener('click', () => {
		const activeTab = document.querySelector('.lang-tab.active');
		const activeLang = activeTab.dataset.lang;
		const title = document.getElementById(`title_${activeLang}`).value || 'Untitled';
		const content = document.getElementById(`content_${activeLang}`).value || '';

	// Markdown to HTML conversion
		let html;
		try {
			// Only parse if content exists and is not empty
			if (content && content.trim()) {
				html = marked.parse(content);
			} else {
				html = '<p>No content to preview</p>';
			}
		} catch (e) {
			console.error('Markdown parsing error:', e);
			// Fallback to simple HTML with line breaks
			html = content ? content.replace(/\n/g, '<br>') : '<p>No content to preview</p>';
		}

		document.getElementById('preview-content').innerHTML = `
			<h1>${title}</h1>
			${html}
		`;
		document.getElementById('preview-modal').style.display = 'block';
	});

	// Close modal
	document.querySelector('.close-modal').addEventListener('click', () => {
		document.getElementById('preview-modal').style.display = 'none';
	});

	// Delete note
	window.deleteNote = async (id) => {
		if (confirm('Are you sure you want to delete this note?')) {
			try {
				const response = await fetch(`/api/notes/${id}`, {
					method: 'DELETE',
				});

				if (response.ok) {
					location.reload();
				} else {
					alert('Failed to delete note');
				}
			} catch (error) {
				console.error('Error:', error);
				alert('Error deleting note');
			}
		}
	};

	// Edit note - redirect to edit page
	window.editNote = (id) => {
		window.location.href = `/admin/edit/${id}`;
	};

	// Header Image Upload - Wait for DOM to be ready
	document.addEventListener('DOMContentLoaded', () => {
		const headerImageInput = document.getElementById('headerImage');
		const headerImageUrlInput = document.getElementById('headerImageUrl');
		const headerImagePreview = document.getElementById('headerImagePreview');
		const headerImagePreviewImg = document.getElementById('headerImagePreviewImg');
		const removeHeaderImageBtn = document.getElementById('removeHeaderImage');

		if (!headerImageInput || !headerImageUrlInput || !headerImagePreview || !headerImagePreviewImg || !removeHeaderImageBtn) {
			console.error('Header image elements not found');
			return;
		}

		headerImageInput.addEventListener('change', async (e) => {
		const file = e.target.files[0];
		if (file) {
			const formData = new FormData();
			formData.append('file', file);

			try {
				const response = await fetch('/api/upload', {
					method: 'POST',
					body: formData
				});

				const result = await response.json();
				if (result.success) {
					headerImageUrlInput.value = result.url;
					headerImagePreviewImg.src = result.url;
					headerImagePreview.style.display = 'block';
				} else {
					alert('Failed to upload image: ' + result.error);
				}
			} catch (error) {
				console.error('Upload error:', error);
				alert('Error uploading image');
			}
		}
	});

	removeHeaderImageBtn.addEventListener('click', () => {
		headerImageUrlInput.value = '';
		headerImagePreview.style.display = 'none';
		headerImageInput.value = '';
	});
	});

	// Content Image Upload - Also wait for DOM
	document.addEventListener('DOMContentLoaded', () => {
		// English content image upload
		const insertImageBtnEn = document.getElementById('insertImageBtn_en');
		const contentImageInputEn = document.getElementById('contentImageInput_en');
		const contentTextareaEn = document.getElementById('content_en');

		// Indonesian content image upload
		const insertImageBtnId = document.getElementById('insertImageBtn_id');
		const contentImageInputId = document.getElementById('contentImageInput_id');
		const contentTextareaId = document.getElementById('content_id');
		// Debug: Log found elements
		console.log('English elements found:', {
			insertImageBtnEn: !!insertImageBtnEn,
			contentImageInputEn: !!contentImageInputEn,
			contentTextareaEn: !!contentTextareaEn
		});

		console.log('Indonesian elements found:', {
			insertImageBtnId: !!insertImageBtnId,
			contentImageInputId: !!contentImageInputId,
			contentTextareaId: !!contentTextareaId
		});

		// Set up event listeners for English
		if (insertImageBtnEn && contentImageInputEn && contentTextareaEn) {
			console.log('Setting up English image upload listeners');
			insertImageBtnEn.addEventListener('click', () => {
				console.log('English insert image clicked');
				contentImageInputEn.click();
			});

			contentImageInputEn.addEventListener('change', async (e) => {
				console.log('English content image changed');
				await handleImageUpload(e, contentTextareaEn);
			});
		} else {
			console.warn('English image upload elements not found');
		}

		// Set up event listeners for Indonesian
		if (insertImageBtnId && contentImageInputId && contentTextareaId) {
			console.log('Setting up Indonesian image upload listeners');
			insertImageBtnId.addEventListener('click', () => {
				console.log('Indonesian insert image clicked');
				contentImageInputId.click();
			});

			contentImageInputId.addEventListener('change', async (e) => {
				console.log('Indonesian content image changed');
				await handleImageUpload(e, contentTextareaId);
			});
		} else {
			console.warn('Indonesian image upload elements not found');
		}

		// Shared image upload handler function
		async function handleImageUpload(e, contentTextarea) {
			console.log('handleImageUpload called with', e.target.files.length, 'files');
		const files = Array.from(e.target.files);

		for (const file of files) {
			const formData = new FormData();
			formData.append('file', file);

			try {
				const response = await fetch('/api/upload', {
					method: 'POST',
					body: formData
				});

				const result = await response.json();
				if (result.success) {
					// Insert markdown image syntax at cursor position
					const imageMarkdown = `\n![${file.name}](${result.url})\n`;
					const startPos = contentTextarea.selectionStart;
					const endPos = contentTextarea.selectionEnd;
					const currentText = contentTextarea.value;

					contentTextarea.value = currentText.substring(0, startPos) + imageMarkdown + currentText.substring(endPos);

					// Set cursor position after inserted text
					const newCursorPos = startPos + imageMarkdown.length;
					contentTextarea.setSelectionRange(newCursorPos, newCursorPos);
					contentTextarea.focus();
				} else {
					alert('Failed to upload image: ' + result.error);
				}
			} catch (error) {
				console.error('Upload error:', error);
				alert('Error uploading image');
			}
		}

		// Clear input for future uploads
		e.target.value = '';
	}
	});
</script>